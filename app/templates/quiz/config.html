{% extends "base.html" %} {% block title %}Configuration Quiz{% endblock %} {%
block content %}
<div class="quiz-config">
  <div class="config-container">
    <h1>Build Your Own Quiz</h1>

    <form id="quizConfigForm">
      <!-- Sélection des thèmes -->
      <div class="form-section">
        <h2>Sélectionner les thèmes</h2>
        <div class="themes-container">
          {% for theme in themes %}
          <label class="checkbox-item">
            <input
              type="checkbox"
              name="themes"
              value="{{ theme }}"
              class="theme-checkbox"
            />
            <span>{{ theme }}</span>
          </label>
          {% endfor %}
        </div>
        <small id="themeCount">0 thème(s) sélectionné(s)</small>
        <small
          id="availableCount"
          style="display: block; color: #007bff; margin-top: 5px"
        ></small>
      </div>

      <!-- Filtres de questions -->
      <div class="form-section">
        <h2>Type de questions</h2>
        <div class="filters-container">
          <label class="checkbox-item">
            <input
              type="checkbox"
              name="question_filters"
              value="new"
              class="filter-checkbox"
              checked
            />
            <span>✓ Questions non répondues</span>
          </label>
          <label class="checkbox-item">
            <input
              type="checkbox"
              name="question_filters"
              value="answered"
              class="filter-checkbox"
              checked
            />
            <span>✓ Questions répondues correctement</span>
          </label>
          <label class="checkbox-item">
            <input
              type="checkbox"
              name="question_filters"
              value="incorrect"
              class="filter-checkbox"
              checked
            />
            <span>✗ Questions répondues faux</span>
          </label>
        </div>
        <small
          id="filterCount"
          style="display: block; color: #666; margin-top: 10px"
        ></small>
      </div>

      <!-- Options d'affichage -->
      <div class="form-section">
        <h2>Options de réponse</h2>
        <label class="radio-item">
          <input type="radio" name="show_answers" value="go" id="show_go" />
          <span>Afficher les réponses au fur et à mesure</span>
        </label>
        <label class="radio-item">
          <input
            type="radio"
            name="show_answers"
            value="end"
            id="show_end"
            checked
          />
          <span>Afficher les réponses à la fin</span>
        </label>
      </div>

      <!-- Nombre de questions -->
      <div class="form-section">
        <h2>Nombre de questions</h2>
        <div class="question-slider">
          <input
            type="range"
            id="numQuestions"
            name="num_questions"
            min="5"
            max="50"
            value="10"
            class="slider"
          />
          <div class="slider-labels">
            <span id="minQuestions">5</span>
            <span id="selectedQuestions">10 questions</span>
            <span id="maxQuestions">50</span>
          </div>
          <small
            id="questionsWarning"
            style="display: none; color: #dc3545; margin-top: 5px"
          ></small>
        </div>
      </div>

      <!-- Boutons -->
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="history.back()"
        >
          Annuler
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          id="startQuizBtn"
          disabled
        >
          Commencer le Quiz
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .quiz-config {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
  }

  .config-container {
    background: white;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  h1 {
    color: #333;
    margin-bottom: 30px;
    text-align: center;
  }

  .form-section {
    margin-bottom: 30px;
  }

  .form-section h2 {
    font-size: 18px;
    color: #555;
    margin-bottom: 15px;
  }

  .themes-container,
  .filters-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
    margin-bottom: 10px;
  }

  .checkbox-item,
  .radio-item {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .checkbox-item:hover,
  .radio-item:hover {
    background: #f0f0f0;
  }

  .checkbox-item input,
  .radio-item input {
    margin-right: 10px;
    cursor: pointer;
  }

  .question-slider {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #ddd;
    outline: none;
    -webkit-appearance: none;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
  }

  .slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: none;
  }

  .slider-labels {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #666;
  }

  #selectedQuestions {
    font-weight: bold;
    color: #007bff;
    flex: 1;
    text-align: center;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 30px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
  }

  .btn-primary {
    background: #007bff;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #0056b3;
  }

  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #545b62;
  }

  #themeCount,
  #availableCount,
  #filterCount {
    display: block;
    color: #666;
    margin-top: 10px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("quizConfigForm");
    const themeCheckboxes = document.querySelectorAll(".theme-checkbox");
    const filterCheckboxes = document.querySelectorAll(".filter-checkbox");
    const numQuestionsSlider = document.getElementById("numQuestions");
    const selectedQuestionsSpan = document.getElementById("selectedQuestions");
    const themeCountSpan = document.getElementById("themeCount");
    const availableCountSpan = document.getElementById("availableCount");
    const filterCountSpan = document.getElementById("filterCount");
    const questionsWarning = document.getElementById("questionsWarning");
    const startBtn = document.getElementById("startQuizBtn");
    const maxQuestionsSpan = document.getElementById("maxQuestions");

    // Mettre à jour le nombre de questions sélectionnées
    numQuestionsSlider.addEventListener("input", function () {
      selectedQuestionsSpan.textContent = this.value + " questions";
      updateAvailableQuestions();
    });

    // Mettre à jour le nombre de thèmes, filtres et les questions disponibles
    function updateThemeCount() {
      const selectedCount = document.querySelectorAll(
        ".theme-checkbox:checked"
      ).length;
      themeCountSpan.textContent = selectedCount + " thème(s) sélectionné(s)";
      startBtn.disabled = selectedCount === 0;
      updateAvailableQuestions();
    }

    function updateFilterCount() {
      const selectedCount = document.querySelectorAll(
        ".filter-checkbox:checked"
      ).length;

      if (selectedCount === 0) {
        filterCountSpan.textContent =
          "⚠️ Sélectionnez au moins un type de question";
        filterCountSpan.style.color = "#dc3545";
        startBtn.disabled = true;
      } else {
        const filterNames = [];
        if (document.querySelector('[value="new"]:checked'))
          filterNames.push("Non répondues");
        if (document.querySelector('[value="answered"]:checked'))
          filterNames.push("Répondues");
        if (document.querySelector('[value="incorrect"]:checked'))
          filterNames.push("Faux");

        filterCountSpan.textContent = "Sélection: " + filterNames.join(", ");
        filterCountSpan.style.color = "#666";
        updateAvailableQuestions();
      }
    }

    async function updateAvailableQuestions() {
      const selectedThemes = Array.from(
        document.querySelectorAll(".theme-checkbox:checked")
      ).map((cb) => cb.value);

      const selectedFilters = Array.from(
        document.querySelectorAll(".filter-checkbox:checked")
      ).map((cb) => cb.value);

      if (selectedThemes.length === 0) {
        availableCountSpan.textContent = "";
        return;
      }

      try {
        const response = await fetch("/quiz/config/questions-count", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            themes: selectedThemes,
            question_filters: selectedFilters,
          }),
        });

        if (response.ok) {
          const result = await response.json();
          const count = result.count;

          // Mettre à jour le max du slider
          const currentValue = parseInt(numQuestionsSlider.value);
          const newMax = Math.max(5, count);
          numQuestionsSlider.max = newMax;
          maxQuestionsSpan.textContent = newMax;

          // Vérifier si la valeur actuelle dépasse le max
          if (currentValue > count) {
            questionsWarning.textContent = `⚠️ Seulement ${count} question(s) disponible(s)`;
            questionsWarning.style.display = "block";
            numQuestionsSlider.value = Math.min(currentValue, count);
            selectedQuestionsSpan.textContent =
              numQuestionsSlider.value + " questions";
          } else {
            questionsWarning.style.display = "none";
          }

          availableCountSpan.textContent = `${count} question(s) disponible(s)`;
        }
      } catch (error) {
        console.error("Erreur:", error);
      }
    }

    themeCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updateThemeCount);
    });

    filterCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updateFilterCount);
    });

    // Initialiser
    updateThemeCount();
    updateFilterCount();

    // Soumettre le formulaire
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        themes: formData.getAll("themes"),
        num_questions: formData.get("num_questions"),
        show_answers: formData.get("show_answers"),
        question_filters: formData.getAll("question_filters"),
      };

      try {
        startBtn.disabled = true;
        startBtn.textContent = "Chargement...";

        const response = await fetch("/quiz/config", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          const result = await response.json();
          window.location.href = result.redirect_url;
        } else {
          const error = await response.json();
          alert("Erreur: " + error.error);
          startBtn.disabled = false;
          startBtn.textContent = "Commencer le Quiz";
        }
      } catch (error) {
        console.error("Erreur:", error);
        alert("Une erreur est survenue");
        startBtn.disabled = false;
        startBtn.textContent = "Commencer le Quiz";
      }
    });
  });
</script>
{% endblock %}
